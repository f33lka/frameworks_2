# Архитектура системы СистемаКонтроля

## Обзор

СистемаКонтроля - микросервисная система управления задачами для строительных объектов, построенная по принципам разделения ответственности и масштабируемости.

## Архитектурная диаграмма

```
┌─────────────────────────────────────────────────────────────┐
│                        Клиенты                              │
│  (Web, Mobile, Third-party apps)                            │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP/HTTPS
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Gateway (Port 3000)                   │
│  ┌────────────────────────────────────────────────────────┐ │
│  │  - Routing & Proxying                                  │ │
│  │  - JWT Authentication                                  │ │
│  │  - Rate Limiting (100 req/min)                         │ │
│  │  - CORS Management                                     │ │
│  │  - Request ID Propagation                              │ │
│  └────────────────────────────────────────────────────────┘ │
└─────┬────────────────────────────────────────┬──────────────┘
      │                                        │
      │                                        │
      ▼                                        ▼
┌──────────────────────┐           ┌─────────────────────────┐
│  Users Service       │           │  Orders Service         │
│  (Port 3001)         │           │  (Port 3002)            │
│                      │           │                         │
│  ┌────────────────┐  │           │  ┌───────────────────┐  │
│  │ Auth           │  │           │  │ Create Order      │  │
│  │ - Register     │  │           │  │ - Get Order       │  │
│  │ - Login        │  │           │  │ - List Orders     │  │
│  │ - JWT Issue    │  │           │  │ - Update Status   │  │
│  └────────────────┘  │           │  │ - Cancel Order    │  │
│                      │           │  └───────────────────┘  │
│  ┌────────────────┐  │           │                         │
│  │ Profile        │  │           │  ┌───────────────────┐  │
│  │ - Get Profile  │  │           │  │ Events            │  │
│  │ - Update       │  │           │  │ - ORDER_CREATED   │  │
│  └────────────────┘  │           │  │ - STATUS_UPDATED  │  │
│                      │           │  └───────────────────┘  │
│  ┌────────────────┐  │           │                         │
│  │ Admin          │  │           │                         │
│  │ - List Users   │  │           │                         │
│  └────────────────┘  │           │                         │
└──────┬───────────────┘           └────────┬────────────────┘
       │                                    │
       │                                    │
       └────────────────┬───────────────────┘
                        │
                        ▼
              ┌──────────────────┐
              │   Supabase DB    │
              │   (PostgreSQL)   │
              │                  │
              │  ┌─────────────┐ │
              │  │ users       │ │
              │  │ - id        │ │
              │  │ - email     │ │
              │  │ - pwd_hash  │ │
              │  │ - name      │ │
              │  │ - roles[]   │ │
              │  └─────────────┘ │
              │                  │
              │  ┌─────────────┐ │
              │  │ orders      │ │
              │  │ - id        │ │
              │  │ - user_id   │ │
              │  │ - items     │ │
              │  │ - status    │ │
              │  │ - total     │ │
              │  └─────────────┘ │
              └──────────────────┘
```

## Компоненты системы

### 1. API Gateway

**Назначение:** Единая точка входа для всех клиентских запросов.

**Ответственность:**
- Маршрутизация запросов к соответствующим микросервисам
- JWT аутентификация (кроме публичных эндпоинтов)
- Rate limiting для защиты от перегрузок
- CORS управление для кросс-доменных запросов
- Прокидывание X-Request-ID для трассировки

**Технологии:**
- Express.js
- http-proxy-middleware
- express-rate-limit
- jsonwebtoken

**Порт:** 3000

### 2. Users Service

**Назначение:** Управление пользователями и аутентификацией.

**Ответственность:**
- Регистрация новых пользователей
- Аутентификация (логин) и выдача JWT токенов
- Управление профилями пользователей
- Административные функции (список пользователей)
- Контроль ролей и прав доступа

**Технологии:**
- Express.js
- bcryptjs (хеширование паролей)
- jsonwebtoken (JWT)
- Zod (валидация)
- Pino (логирование)

**Порт:** 3001

**Роли:**
- `user` - обычный пользователь
- `manager` - менеджер проектов
- `admin` - администратор

### 3. Orders Service

**Назначение:** Управление заказами строительных материалов.

**Ответственность:**
- Создание заказов с валидацией
- Получение информации о заказах
- Список заказов с фильтрацией и пагинацией
- Обновление статуса заказов
- Отмена заказов
- Публикация доменных событий
- Контроль доступа к заказам

**Технологии:**
- Express.js
- Zod (валидация)
- Pino (логирование)

**Порт:** 3002

**Статусы заказов:**
- `created` - создан
- `in_progress` - в работе
- `completed` - завершён
- `cancelled` - отменён

### 4. База данных (Supabase)

**Назначение:** Хранение данных приложения.

**Таблицы:**

#### users
- `id` (uuid) - уникальный идентификатор
- `email` (text) - электронная почта (уникальная)
- `password_hash` (text) - хеш пароля
- `name` (text) - имя пользователя
- `roles` (text[]) - массив ролей
- `created_at` (timestamptz) - дата создания
- `updated_at` (timestamptz) - дата обновления

#### orders
- `id` (uuid) - уникальный идентификатор
- `user_id` (uuid) - ссылка на пользователя
- `items` (jsonb) - состав заказа
- `status` (text) - статус заказа
- `total_amount` (numeric) - итоговая сумма
- `created_at` (timestamptz) - дата создания
- `updated_at` (timestamptz) - дата обновления

**Безопасность:**
- Row Level Security (RLS) включён
- Service role ключ используется только на бэкенде
- Политики доступа настроены на уровне приложения

## Потоки данных

### Регистрация пользователя

```
Client → API Gateway → Users Service → Supabase
  1. POST /api/v1/auth/register
  2. Валидация данных (Zod)
  3. Проверка существования email
  4. Хеширование пароля (bcrypt)
  5. Создание записи в БД
  6. Возврат данных пользователя
```

### Аутентификация

```
Client → API Gateway → Users Service → Supabase
  1. POST /api/v1/auth/login
  2. Поиск пользователя по email
  3. Проверка пароля (bcrypt.compare)
  4. Генерация JWT токена
  5. Возврат токена и данных пользователя
```

### Создание заказа

```
Client → API Gateway → Orders Service → Supabase
  1. POST /api/v1/orders (с JWT токеном)
  2. Gateway проверяет JWT
  3. Валидация данных заказа
  4. Проверка существования пользователя
  5. Расчёт итоговой суммы
  6. Создание записи заказа
  7. Публикация события ORDER_CREATED
  8. Возврат данных заказа
```

### Получение списка заказов

```
Client → API Gateway → Orders Service → Supabase
  1. GET /api/v1/orders?page=1&limit=10
  2. Gateway проверяет JWT
  3. Определение прав пользователя (user/manager/admin)
  4. Фильтрация по user_id (для обычных пользователей)
  5. Применение пагинации и сортировки
  6. Возврат списка и метаданных пагинации
```

## Безопасность

### Аутентификация и авторизация

1. **JWT Tokens**
   - Алгоритм: HS256
   - Срок действия: 7 дней
   - Payload содержит: id, email, roles

2. **Проверка на уровне Gateway**
   - Все эндпоинты защищены, кроме:
     - /health
     - /api/v1/auth/register
     - /api/v1/auth/login

3. **Проверка на уровне сервисов**
   - Дополнительная валидация токена
   - Проверка прав доступа к ресурсам
   - Контроль владения ресурсами

### Защита от атак

1. **Rate Limiting**
   - 100 запросов в минуту на IP
   - Защита от DDoS и brute-force

2. **Input Validation**
   - Валидация всех входящих данных через Zod
   - Защита от SQL injection (через ORM)
   - Защита от XSS (через санитизацию)

3. **Password Security**
   - Хеширование через bcrypt (10 раундов)
   - Минимальная длина пароля: 8 символов

4. **CORS**
   - Настроенные правила для кросс-доменных запросов
   - Контроль allowed origins

### Row Level Security (RLS)

- RLS включён на всех таблицах
- Service role ключ используется для обхода RLS на бэкенде
- Логика безопасности реализована на уровне приложения

## Наблюдаемость

### Логирование

**Структурированные логи (Pino):**
- Все сервисы используют единый формат
- Уровни: debug, info, warn, error
- Контекст запроса включает requestId

**Логируемые события:**
- HTTP запросы и ответы
- Ошибки и исключения
- Бизнес-события (создание/обновление заказов)
- Проблемы авторизации
- Rate limiting срабатывания

### Трассировка

**X-Request-ID:**
- Генерируется в Gateway (или принимается от клиента)
- Прокидывается во все микросервисы
- Возвращается в ответе клиенту
- Логируется на всех этапах обработки

**Пример трассировки:**
```
[Gateway] requestId: abc-123 → Received request
[Users Service] requestId: abc-123 → Processing authentication
[Supabase] requestId: abc-123 → Query executed
[Users Service] requestId: abc-123 → Response sent
[Gateway] requestId: abc-123 → Request completed
```

### Health Checks

Каждый сервис предоставляет `/health` эндпоинт:
```json
{
  "success": true,
  "data": {
    "service": "users-service",
    "status": "healthy",
    "timestamp": "2025-10-09T12:00:00.000Z"
  }
}
```

## Масштабируемость

### Горизонтальное масштабирование

Каждый микросервис может быть масштабирован независимо:

```yaml
# Пример для Kubernetes
replicas:
  api-gateway: 2
  users-service: 3
  orders-service: 3
```

### Stateless архитектура

- Сервисы не хранят состояние между запросами
- JWT токены не требуют серверного хранения
- Все данные в централизованной БД

### Кэширование (будущее)

Планируется добавить:
- Redis для кэширования часто запрашиваемых данных
- Кэш профилей пользователей
- Кэш списков заказов

## Отказоустойчивость

### Circuit Breaker (будущее)

Планируется реализация шаблона Circuit Breaker для:
- Защиты от каскадных сбоев
- Быстрого отказа при недоступности сервиса
- Автоматического восстановления

### Graceful Shutdown

Все сервисы поддерживают корректное завершение:
1. Прекращение приёма новых запросов
2. Завершение обработки текущих запросов
3. Закрытие соединений с БД
4. Завершение процесса

### Health Checks в Docker

Docker Compose настроен с health checks:
- Интервал проверки: 30 секунд
- Timeout: 10 секунд
- Retries: 3

## События и интеграция

### Доменные события

Текущие события:
- `ORDER_CREATED` - при создании заказа
- `ORDER_STATUS_UPDATED` - при изменении статуса

События логируются и готовы к интеграции с:
- RabbitMQ
- Apache Kafka
- AWS SQS

### Webhook готовность

Архитектура позволяет легко добавить:
- Отправку webhook при событиях
- Подписку на внешние webhook
- Асинхронную обработку событий

## Развёртывание

### Docker Compose (dev/staging)

```bash
docker-compose up -d
```

Все сервисы в одной сети, переменные окружения из `.env`.

### Kubernetes (production)

Рекомендуемая структура:
```
- Namespace: sistema-control
  - Deployment: api-gateway (2 реплики)
  - Deployment: users-service (3 реплики)
  - Deployment: orders-service (3 реплики)
  - Service: LoadBalancer для Gateway
  - Service: ClusterIP для микросервисов
  - ConfigMap: конфигурация
  - Secret: чувствительные данные (JWT_SECRET, DB credentials)
```

### CI/CD

Рекомендуемый pipeline:
1. Lint и проверка кода
2. Сборка Docker образов
3. Push в Container Registry
4. Запуск тестов
5. Deploy в staging
6. Smoke tests
7. Deploy в production (после одобрения)

## Мониторинг (будущее)

Планируется добавить:
- **Prometheus** для метрик
- **Grafana** для визуализации
- **Jaeger** для распределённой трассировки
- **ELK Stack** для централизованных логов

## Производительность

### Текущие показатели

- Gateway: ~500 запросов/сек (без оптимизации)
- Users Service: ~300 запросов/сек
- Orders Service: ~300 запросов/сек

### Узкие места

1. Синхронные вызовы БД
2. Отсутствие кэширования
3. Single-threaded Node.js

### Оптимизации (будущее)

1. Connection pooling для БД
2. Redis кэш для горячих данных
3. Асинхронная обработка событий через очереди
4. CDN для статического контента

## Расширение системы

### Добавление нового микросервиса

1. Создайте директорию в `services/`
2. Скопируйте структуру существующего сервиса
3. Реализуйте бизнес-логику
4. Добавьте proxy в API Gateway
5. Добавьте сервис в docker-compose.yml
6. Обновите документацию

### Интеграция с внешними системами

Планируется:
- 1С для учёта
- CRM системы
- Платёжные системы
- Email/SMS провайдеры

## Заключение

Архитектура системы СистемаКонтроля построена с учётом:
- **Модульности** - легко добавлять новые сервисы
- **Безопасности** - многоуровневая защита
- **Наблюдаемости** - логи и трассировка из коробки
- **Масштабируемости** - независимое масштабирование сервисов
- **Отказоустойчивости** - health checks и graceful shutdown

Система готова к расширению и оптимизации под растущие требования бизнеса.
